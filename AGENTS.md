# AGENTS.md

> Codex が実装時に最初に読む運用ルールです。**迷ったらこのファイルを優先**してください。

## 1. 最重要ルール（必須）

1. **Next.js の最新設計を採用する。**
   - 必ず公式ドキュメントを参照して判断する。
2. **SEO を高度に最適化する。**
3. **リアルタイムチャット機能を実装する。**
4. **AWS に最小コストでデプロイする。**

## 2. 実装前チェックリスト（必須）

- [ ] 優先順位（上記 1〜4）を確認した
- [ ] 変更前に作業ブランチを作成した
- [ ] PR 本文に「実装内容」「実装理由」「提案・懸念点」を書く準備をした
- [ ] 実装中の提案・懸念点・問題点を `docs/proposals.md` に記録する方針を確認した

## 3. 実装中の運用ルール（必須）

1. PR 本文は **必ず日本語** で、後述「4. PR 記載テンプレート（必須）」の見出しを順番どおりに使用する。
2. PR には次をわかりやすく詳細に記載する。
   - 何を実装・修正したか
   - なぜその実装方針にしたか（判断理由）
   - テスト/確認コマンドと結果
   - 影響範囲（ユーザー、SEO、チャット、AWSコスト）
3. 変更が 500 行超になる場合は、PR 本文に「分割できない理由」を明記する。
4. PR 作成時は、差分に無関係な変更（無関係な整形、不要なリネーム、別目的の修正）を含めない。
5. スクリーンショットがある場合は、PR 本文の「動作確認」に添付し、確認観点を 1 行で書く。
6. `docs/proposals.md` に記載するのは、**当該タスクで実際に触ったリポジトリ内の記述・コードに対する提案/懸念/問題点のみ** とする。
   - 対象: 実装・調査の中で確認した、ファイル差分や既存コード構造に起因する事項。
   - 非対象: ユーザーからの質問文・相談文そのもの、雑談、すでに解決済みで追跡不要な事項。
   - 最終判断はプロジェクトオーナーが行う。
7. PR 作成のため、リポジトリへ変更を入れる前に必ず作業ブランチを作成する。

## 4. PR 記載テンプレート（必須）

以下を **必ずこの順序・見出し名で** 記載する。

### 1) 実装・修正内容
- 何を変更したかを箇条書きで記載する。
- UI 変更時は対象画面/コンポーネント名を書く。

### 2) 実装理由
- 「採用案」「却下案」「採用理由（性能・保守性・コスト・納期）」を最低 1 件ずつ記載する。

### 3) 変更ファイル
- 主要ファイルのみを列挙し、各ファイルの変更意図を 1 行で書く。

### 4) 動作確認
- 実行コマンドをコードブロックで記載し、各コマンドに `PASS` / `FAIL` を明記する。
- 手動確認を行った場合は、確認手順と結果を記載する。

### 5) 影響範囲
- 以下 4 項目を必ず記載する（影響なしでも `なし` と書く）。
  - Next.js 最新設計への整合性
  - SEO 影響
  - リアルタイムチャット機能への影響
  - AWS コスト影響（増減見込み）

### 6) 提案・懸念点
- `docs/proposals.md` に追記した ID（例: `P-012`）を列挙する。
- 各 ID について「今回対応する/しない」を明記する。
- ここには、**当該タスクで実際に確認した repo 内の提案/懸念/問題点のみ** を書く（ユーザーの質問文そのものは書かない）。

### 7) リスクとロールバック
- 想定リスクを箇条書きで記載する。
- 失敗時に戻す手順（ロールバック手順）を 1 つ以上記載する。

### 記載例

```text
## 実装・修正内容
- 商品詳細ページの構造化データ生成を `generateMetadata` に統合

## 実装理由
- 採用案: App Router の Metadata API に統一
- 却下案: 既存の `Head` コンポーネントで都度注入
- 採用理由: 重複定義を防ぎ、保守性と SEO 一貫性を確保できるため

## 変更ファイル
- `src/app/products/[id]/page.tsx`: Metadata 生成処理を追加

## 動作確認
- 実行コマンド:
  - `npm run lint`
  - `npm run test`
- 結果:
  - `npm run lint`: PASS
  - `npm run test`: PASS
- 手動確認: `/products/1` で title/description/JSON-LD を確認

## 影響範囲
- Next.js 最新設計への整合性: あり（Metadata API に統一）
- SEO 影響: あり（構造化データ追加）
- リアルタイムチャット機能への影響: なし
- AWS コスト影響: なし

## 提案・懸念点
- P-012（対応する）: 商品一覧のOGP画像自動生成を次タスク化
- P-013（対応しない）: 相談メッセージ自体は proposals に転記しない（repo内で確認した論点のみ記録）

## リスクとロールバック
- リスク: metadata 生成失敗時に title が欠落する可能性
- ロールバック: 当該コミットを revert し、旧 `Head` 実装へ戻す
```

## 5. Codex 向け実行手順（推奨）

1. この `AGENTS.md` を読む。
2. 対象ファイルを確認し、変更範囲を最小化して実装する。
3. テストまたは確認コマンドを実行し、結果を PR に記載する。
4. `docs/proposals.md` の提案ログを更新する。
5. コミット後に PR を作成する。
