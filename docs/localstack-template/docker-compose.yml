version: "3.9"

services:
  localstack:
    container_name: localstack-main
    image: localstack/localstack:3.4
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"
    environment:
      - DEBUG=1
      - AWS_DEFAULT_REGION=ap-northeast-1
      - SERVICES=s3,dynamodb,lambda,apigateway,iam,cloudwatch,logs,sts,cognito-idp
      - LAMBDA_EXECUTOR=docker-reuse
      - LAMBDA_RUNTIME_ENVIRONMENT_TIMEOUT=60
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PERSISTENCE=1
      - LOCALSTACK_HOST=localstack
    volumes:
      - "./.localstack:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./init:/etc/localstack/init/ready.d"
      - "./init/lambda:/opt/localstack/lambda"
    healthcheck:
      test: ["CMD", "bash", "-c", "awslocal sts get-caller-identity"]
      interval: 10s
      timeout: 5s
      retries: 20

  nextjs:
    container_name: nextjs-dev
    image: node:20.18.0-bookworm
    working_dir: /app
    command: bash -lc "npm ci && npm run dev -- --hostname 0.0.0.0 --port 3000"
    volumes:
      - ../..:/app
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:8080/api
      - NEXT_PUBLIC_OIDC_ISSUER=http://localhost:8081/realms/local-ec
      - NEXT_PUBLIC_OIDC_CLIENT_ID=local-ec-web
    depends_on:
      localstack:
        condition: service_healthy

  nginx:
    container_name: cloudfront-mock
    image: nginx:1.27-alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./dist:/usr/share/nginx/html:ro
    depends_on:
      - localstack

  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:25.0
    command: start-dev --http-port=8081 --import-realm
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=postgres
      - KC_DB_URL_HOST=keycloak-db
      - KC_DB_URL_DATABASE=keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=keycloak
    ports:
      - "8081:8081"
    volumes:
      - ./keycloak/realm-export:/opt/keycloak/data/import
    depends_on:
      - keycloak-db

  keycloak-db:
    container_name: keycloak-db
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=keycloak
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data

volumes:
  keycloak-db-data:
