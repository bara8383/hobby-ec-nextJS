name: Auto Fill PR Body

on:
  pull_request_target:
    types: [opened, reopened, edited]

permissions:
  pull-requests: write
  contents: read

jobs:
  autofill:
    runs-on: ubuntu-latest
    steps:
      - name: Auto fill PR body when empty or placeholder
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          is_placeholder=false
          placeholders=(
            "Codex generated this pull request, but encountered an unexpected error after generation. This is a placeholder PR message."
            "Codex-generated pull request"
          )

          for p in "${placeholders[@]}"; do
            if [[ "${PR_TITLE:-}" == *"$p"* ]] || [[ "${PR_BODY:-}" == *"$p"* ]]; then
              is_placeholder=true
              break
            fi
          done

          is_body_empty=false
          if [[ -z "${PR_BODY//[[:space:]]/}" ]]; then
            is_body_empty=true
          fi

          if [[ "$is_placeholder" != true && "$is_body_empty" != true ]]; then
            echo "PR本文は空でもプレースホルダーでもないため、更新しません。"
            exit 0
          fi

          new_title="$PR_TITLE"
          if [[ "$PR_TITLE" == *"Codex-generated pull request"* ]]; then
            new_title="PRタイトルを更新してください"
          fi

          fallback_body=$(cat <<'EOF'
## 実装前チェック（AGENTS.md）
- [ ] 優先順位（Next.js 最新設計 / SEO / リアルタイムチャット / AWS最小コスト）を確認した
- [ ] 変更前に作業ブランチを作成した
- [ ] 実装中の提案・懸念点・問題点を `docs/proposals.md` に記録した

## 実装・修正内容
- (記入してください)
## 実装理由
- (記入してください)
## 提案・懸念点
- (記入してください)
> NOTE: PR本文が空またはプレースホルダーだったため、自動補完されました。内容を更新してください。
EOF
)

          gh api \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            "/repos/${REPO}/pulls/${PR_NUMBER}" \
            -f "title=${new_title}" \
            -f "body=${fallback_body}" > /dev/null

          gh api \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${REPO}/issues/${PR_NUMBER}/comments" \
            -f "body=本文を自動補完しました。レビュー開始前に『実装・修正内容 / 実装理由 / 提案・懸念点』を更新してください。" > /dev/null

          echo "PR #${PR_NUMBER} の本文を自動補完し、通知コメントを投稿しました。"
