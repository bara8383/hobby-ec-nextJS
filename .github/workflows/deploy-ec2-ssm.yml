name: deploy-ec2-ssm

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_CI_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Run deploy script through SSM
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          GITHUB_OWNER: ${{ vars.GITHUB_OWNER }}
          GITHUB_REPO: ${{ vars.GITHUB_REPO }}
          GITHUB_BRANCH: ${{ vars.GITHUB_BRANCH || 'main' }}
        run: |
          set -euo pipefail

          COMMANDS=$(cat <<JSON
          [
            "set -euo pipefail",
            "if [ ! -f /opt/app/scripts/deploy/ec2_deploy.sh ]; then rm -rf /opt/app/* && git clone --branch ${GITHUB_BRANCH} https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}.git /opt/app; fi",
            "chmod +x /opt/app/scripts/deploy/ec2_deploy.sh",
            "GITHUB_OWNER=${GITHUB_OWNER} GITHUB_REPO=${GITHUB_REPO} GITHUB_BRANCH=${GITHUB_BRANCH} /opt/app/scripts/deploy/ec2_deploy.sh"
          ]
          JSON
          )

          COMMAND_ID=$(aws ssm send-command \
            --region "$AWS_REGION" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy ${GITHUB_REPO} via SSM" \
            --targets "Key=tag:Env,Values=prod" "Key=tag:Role,Values=web" \
            --parameters "commands=${COMMANDS}" \
            --query "Command.CommandId" \
            --output text)

          INSTANCE_ID=$(aws ec2 describe-instances \
            --region "$AWS_REGION" \
            --filters "Name=tag:Env,Values=prod" "Name=tag:Role,Values=web" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          echo "command_id=${COMMAND_ID}" >> "$GITHUB_OUTPUT"
          echo "instance_id=${INSTANCE_ID}" >> "$GITHUB_OUTPUT"

          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" = "None" ]; then
            echo "No running EC2 instance found with tags Env=prod and Role=web"
            exit 1
          fi

          for _ in $(seq 1 60); do
            STATUS=$(aws ssm get-command-invocation \
              --region "$AWS_REGION" \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query "Status" \
              --output text || true)

            if [ "$STATUS" = "Success" ]; then
              break
            fi

            if [ "$STATUS" = "Failed" ] || [ "$STATUS" = "TimedOut" ] || [ "$STATUS" = "Cancelled" ]; then
              aws ssm get-command-invocation \
                --region "$AWS_REGION" \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --output json
              echo "SSM command failed with status: $STATUS"
              exit 1
            fi

            sleep 5
          done

          aws ssm get-command-invocation \
            --region "$AWS_REGION" \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --output json

          FINAL_STATUS=$(aws ssm get-command-invocation \
            --region "$AWS_REGION" \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "Status" \
            --output text)

          if [ "$FINAL_STATUS" != "Success" ]; then
            echo "SSM command did not reach Success. Final status: $FINAL_STATUS"
            exit 1
          fi
